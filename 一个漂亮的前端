export default {
	async fetch(request, env, ctx) {
		const targetHost = env.DESTINATION;
		const uuid = env.UUID || '';
		const url = new URL(request.url);
		const currentHost = request.headers.get('Host');

		if (uuid && url.pathname === `/${uuid}/sub`) {
			if (!targetHost) {
				return new Response('Destination not configured', { status: 500 });
			}
			
			try {
				const targetUrl = new URL(request.url);
				targetUrl.hostname = targetHost;

				const headers = new Headers(request.headers);
				headers.set('X-Forwarded-Host', currentHost);

				const response = await fetch(targetUrl.toString(), {
					method: request.method,
					headers: headers,
				});
				
				return new Response(await response.text(), {
					headers: response.headers
				});
			} catch (err) {
				return new Response('Subscription fetch failed: ' + err.message, { status: 502 });
			}
		}

		if (request.headers.get('Upgrade') === 'websocket') {
			if (!targetHost) {
				return new Response('Destination not configured for WebSocket', { status: 500 });
			}
			return await handleWebSocketProxy(targetHost, request, currentHost);
		}

		return new Response(getUfoCardHtml(uuid, targetHost), {
			headers: {
				'Content-Type': 'text/html; charset=utf-8'
			}
		});
	}
};

function getUfoCardHtml(uuid, dest) {
	const dot1Color = uuid ? '#4CAF50' : '#F44336';
	const dot2Color = dest ? '#4CAF50' : '#F44336';

	return `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UFO</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden;
        }

        .card {
            width: 320px;
            height: 450px;
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .status-dots {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 8px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .ufo-container {
            width: 150px;
            height: 150px;
            margin-bottom: 40px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }

        .text {
            font-size: 18px;
            color: #333;
            font-weight: 600;
        }

        .btn-warp {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
        }

        .btn-warp button {
            padding: 10px 24px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #1a237e, #0d47a1);
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(26, 35, 126, 0.4);
            transition: all 0.2s ease;
        }

        .btn-warp button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 35, 126, 0.5);
        }

        /* å¡”ç½—ç‰Œé®ç½© */
        .tarot-overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(ellipse at center, rgba(20, 20, 50, 0.95), rgba(5, 5, 20, 0.98));
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .tarot-overlay.show {
            display: flex;
        }

        /* èƒŒæ™¯æ˜Ÿæ˜Ÿ */
        .stars-bg {
            position: absolute;
            inset: 0;
            overflow: hidden;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #fff;
            border-radius: 50%;
            opacity: 0;
            animation: starTwinkle 2s ease-in-out infinite;
        }

        @keyframes starTwinkle {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
        }

        /* å¡”ç½—ç‰Œ */
        .tarot-card {
            width: 300px;
            height: 440px;
            perspective: 1000px;
            cursor: pointer;
        }

        .tarot-inner {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .tarot-card.flipped .tarot-inner {
            transform: rotateY(180deg);
        }

        .tarot-front, .tarot-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 20px;
            overflow: hidden;
        }

        /* ç‰ŒèƒŒ */
        .tarot-front {
            background: linear-gradient(160deg, #1a1a3e, #0d0d2b);
            border: 2px solid rgba(255, 215, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 0 30px rgba(255, 215, 0, 0.1),
                0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .tarot-front::before {
            content: '';
            position: absolute;
            inset: 10px;
            border: 1px solid rgba(255, 215, 0, 0.15);
            border-radius: 14px;
        }

        .card-back-pattern {
            width: 140px;
            height: 140px;
            position: relative;
        }

        .pattern-ring {
            position: absolute;
            inset: 0;
            border: 2px solid rgba(255, 215, 0, 0.2);
            border-radius: 50%;
            animation: ringPulse 3s ease-in-out infinite;
        }

        .pattern-ring:nth-child(2) {
            inset: 15px;
            animation-delay: 0.3s;
        }

        .pattern-ring:nth-child(3) {
            inset: 30px;
            animation-delay: 0.6s;
        }

        @keyframes ringPulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        .pattern-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            animation: iconFloat 2s ease-in-out infinite;
        }

        @keyframes iconFloat {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        .tap-hint {
            margin-top: 30px;
            font-size: 13px;
            color: rgba(255, 215, 0, 0.5);
            animation: hintPulse 2s ease-in-out infinite;
        }

        @keyframes hintPulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.8; }
        }

        /* ç‰Œé¢ */
        .tarot-back {
            background: linear-gradient(160deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            border: 2px solid rgba(255, 215, 0, 0.3);
            transform: rotateY(180deg);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 24px;
            box-shadow: 
                0 0 50px rgba(255, 215, 0, 0.2),
                0 0 100px rgba(100, 150, 255, 0.1),
                0 25px 60px rgba(0, 0, 0, 0.6);
        }

        .tarot-back::before {
            content: '';
            position: absolute;
            inset: 8px;
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 14px;
            pointer-events: none;
        }

        /* æµå…‰è¾¹æ¡† */
        .tarot-back::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 22px;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 215, 0, 0.4), 
                transparent, 
                rgba(100, 200, 255, 0.4), 
                transparent);
            background-size: 300% 100%;
            animation: borderGlow 3s linear infinite;
            z-index: -1;
            opacity: 0;
        }

        .tarot-card.revealed .tarot-back::after {
            opacity: 1;
        }

        @keyframes borderGlow {
            0% { background-position: 100% 0; }
            100% { background-position: -100% 0; }
        }

        .tarot-icon {
            font-size: 72px;
            margin-bottom: 12px;
            filter: drop-shadow(0 0 25px rgba(255, 255, 255, 0.5));
            opacity: 0;
            transform: scale(0.5) translateY(20px);
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .tarot-card.revealed .tarot-icon {
            opacity: 1;
            transform: scale(1) translateY(0);
        }

        .tarot-number {
            font-size: 11px;
            color: rgba(255, 215, 0, 0.6);
            letter-spacing: 4px;
            margin-bottom: 8px;
            opacity: 0;
            transition: opacity 0.4s ease 0.2s;
        }

        .tarot-card.revealed .tarot-number {
            opacity: 1;
        }

        .tarot-title {
            font-size: 24px;
            color: #fff;
            font-weight: 600;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.5s ease 0.3s;
        }

        .tarot-card.revealed .tarot-title {
            opacity: 1;
            transform: translateY(0);
        }

        .tarot-divider {
            width: 80px;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.7), transparent);
            margin-bottom: 24px;
            opacity: 0;
            transition: opacity 0.4s ease 0.4s;
        }

        .tarot-card.revealed .tarot-divider {
            opacity: 1;
        }

        .tarot-prophecy {
            font-size: 15px;
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            line-height: 2;
            padding: 0 8px;
            flex: 1;
            display: flex;
            align-items: center;
            opacity: 0;
            transform: translateY(15px);
            transition: all 0.6s ease 0.5s;
        }

        .tarot-card.revealed .tarot-prophecy {
            opacity: 1;
            transform: translateY(0);
        }

        .tarot-close {
            margin-top: 20px;
            padding: 10px 32px;
            border: 1px solid rgba(255, 215, 0, 0.4);
            background: rgba(255, 215, 0, 0.05);
            color: rgba(255, 215, 0, 0.9);
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0;
        }

        .tarot-card.revealed .tarot-close {
            opacity: 1;
            transition: all 0.2s ease 0.7s;
        }

        .tarot-close:hover {
            background: rgba(255, 215, 0, 0.15);
            border-color: rgba(255, 215, 0, 0.6);
            transform: scale(1.02);
        }

        /* å…‰æ™•æ•ˆæœ */
        .glow-orb {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.15), transparent 70%);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.8s ease;
        }

        .tarot-card.revealed .glow-orb {
            opacity: 1;
            animation: orbFloat 4s ease-in-out infinite;
        }

        @keyframes orbFloat {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
        }

        .glow-orb.orb1 { top: 20%; left: 20%; animation-delay: 0s; }
        .glow-orb.orb2 { top: 80%; left: 80%; animation-delay: 1s; background: radial-gradient(circle, rgba(100, 200, 255, 0.1), transparent 70%); }
        .glow-orb.orb3 { top: 50%; left: 50%; animation-delay: 2s; background: radial-gradient(circle, rgba(255, 100, 200, 0.08), transparent 70%); }
    </style>
</head>
<body>
    <div class="card">
        <div class="status-dots">
            <div class="dot" style="background-color: ${dot1Color};"></div>
            <div class="dot" style="background-color: ${dot2Color};"></div>
        </div>

        <div class="ufo-container">
            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="dome-grad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#81D4FA;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#29B6F6;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <path d="M30,90 L70,90 L60,60 L40,60 Z" fill="#E1F5FE" opacity="0.7"/>
                <ellipse cx="50" cy="60" rx="40" ry="12" fill="#78909C" stroke="#546E7A" stroke-width="1"/>
                <path d="M25,60 Q25,30 50,30 Q75,30 75,60 Z" fill="url(#dome-grad)" stroke="#0288D1" stroke-width="1"/>
                <path d="M35,45 Q40,35 50,35" fill="none" stroke="rgba(255,255,255,0.6)" stroke-width="3" stroke-linecap="round"/>
                <circle cx="35" cy="60" r="3" fill="#FFEB3B"/>
                <circle cx="50" cy="60" r="3" fill="#FFEB3B"/>
                <circle cx="65" cy="60" r="3" fill="#FFEB3B"/>
            </svg>
        </div>

        <div class="text">è¿™é‡Œæ˜¯UFOï¼Œä¸æ˜¯å…¶ä»–çš„å“¦</div>

        <div class="btn-warp">
            <button id="btnWarp">æ˜Ÿé™…ç©¿æ¢­</button>
        </div>
    </div>

    <!-- å¡”ç½—ç‰Œé®ç½© -->
    <div class="tarot-overlay" id="overlay">
        <div class="stars-bg" id="starsBg"></div>
        
        <div class="tarot-card" id="tarotCard">
            <div class="tarot-inner">
                <!-- ç‰ŒèƒŒ -->
                <div class="tarot-front">
                    <div class="card-back-pattern">
                        <div class="pattern-ring"></div>
                        <div class="pattern-ring"></div>
                        <div class="pattern-ring"></div>
                        <div class="pattern-center">ğŸ”®</div>
                    </div>
                    <div class="tap-hint">ç‚¹å‡»ç¿»ç‰Œ</div>
                </div>
                
                <!-- ç‰Œé¢ -->
                <div class="tarot-back">
                    <div class="glow-orb orb1"></div>
                    <div class="glow-orb orb2"></div>
                    <div class="glow-orb orb3"></div>
                    <div class="tarot-icon" id="tarotIcon"></div>
                    <div class="tarot-number" id="tarotNumber"></div>
                    <div class="tarot-title" id="tarotTitle"></div>
                    <div class="tarot-divider"></div>
                    <div class="tarot-prophecy" id="tarotProphecy"></div>
                    <button class="tarot-close" id="btnClose">è¿”å›</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const tarotDeck = [
            { icon: 'ğŸ“¦', name: 'æ˜Ÿé™…è´§ä»“å‘˜', prophecy: 'æ”¶çº³æ˜Ÿæ²³çš„è¡Œå›Šï¼Œä¹Ÿåˆ«å¿˜è®°å®‰æ”¾è‡ªå·±çš„æ˜Ÿå…‰ã€‚' },
            { icon: 'ğŸ«', name: 'æ˜Ÿæ¸¯æ£€ç¥¨å‘˜', prophecy: 'ä¸ºä»–äººå¼€å¯æ—…ç¨‹ï¼Œä¹Ÿè¦è®°å¾—å¥”èµ´å±äºä½ çš„è¿œæ–¹ã€‚' },
            { icon: 'ğŸ§¹', name: 'æ˜Ÿé™…æ¸…æ´å·¥', prophecy: 'æ‰«å»å°˜åŸƒä¸å–§åš£ï¼Œå®ˆä½å†…å¿ƒå¹²å‡€çš„å…‰äº®ã€‚' },
            { icon: 'ğŸœ', name: 'å¤ªç©ºé¤è½¦è´©', prophecy: 'ç”¨æ¸©æš–å¡«æ»¡æ—…é€”ï¼Œåˆ«è®©å¿™ç¢Œå†²æ·¡ç”Ÿæ´»çš„ç”œã€‚' },
            { icon: 'ğŸ”§', name: 'æ˜Ÿèˆ°ç»´ä¿®å‘˜', prophecy: 'ä¿®è¡¥ä¸‡åƒæ•…éšœï¼Œä¹Ÿåˆ«å¿½ç•¥å†…å¿ƒçš„å°å°è£‚ç—•ã€‚' },
            { icon: 'âœ‰ï¸', name: 'æ˜Ÿé™…ä¿¡ä½¿', prophecy: 'ä¼ é€’ç¾å¥½ä¸å¸Œæœ›ï¼Œä¹Ÿå‹‡æ•¢è¡¨è¾¾å¿ƒåº•çš„å£°éŸ³ã€‚' },
            { icon: 'ğŸŒ¾', name: 'æ®–æ°‘æ˜Ÿå†œå¤«', prophecy: 'è€•è€˜è’èŠœæˆæ²ƒåœŸï¼Œè€å¿ƒç­‰å¾…ç»ˆæœ‰ä¸°æ”¶ä¹‹æ—¶ã€‚' },
            { icon: 'ğŸ“‹', name: 'ç©ºé—´ç«™æ–‡å‘˜', prophecy: 'ä¹¦å†™è§„åˆ™ä¸ç§©åºï¼Œä¿æŒæ¸…é†’ä¸è¢«æ¡†æ¶æŸç¼šã€‚' },
            { icon: 'ğŸš•', name: 'æ˜Ÿé™…å‡ºç§Ÿå¸æœº', prophecy: 'è½½è·¯äººæŠµè¾¾å½’é€”ï¼Œç»ˆä¼šé‡è§å±äºä½ çš„æ¸¯æ¹¾ã€‚' },
            { icon: 'ğŸ“¡', name: 'å¤ªç©ºä¿¡å·å‘˜', prophecy: 'è¿æ¥å®‡å®™çš„å£°éŸ³ï¼Œå®ˆä½çœŸè¯šä¸è¢«æ‚éŸ³æ‰°ä¹±ã€‚' },
            { icon: 'ğŸ°', name: 'æ˜Ÿé™…å…¸å½“å¸ˆ', prophecy: 'è¡¡é‡ä¸–é—´çš„çè´µï¼Œå®ˆä½åˆå¿ƒä¸è¢«ä»·å€¼å®šä¹‰ã€‚' },
            { icon: 'ğŸ›ï¸', name: 'æ˜Ÿèˆ°ä¹˜åŠ¡å‘˜', prophecy: 'é™ªä¼´æ¯ä¸€æ®µè¿œè¡Œï¼Œå¹³å‡¡åšå®ˆä¹Ÿè‡ªæœ‰å…‰èŠ’ã€‚' },
            { icon: 'â›ï¸', name: 'æ·±ç©ºçŸ¿å·¥', prophecy: 'å¼€é‡‡æ˜Ÿè¾°å®è—ï¼Œå®ˆä½åº•çº¿ä¸è¢«æ¬²æœ›åå™¬ã€‚' },
            { icon: 'ğŸ—ºï¸', name: 'æ˜Ÿé™…å¯¼æ¸¸', prophecy: 'è®²è¿°æ˜Ÿæ²³æµªæ¼«ï¼Œç”¨å¿ƒæ„Ÿå—æ¯ä¸€å¤„é£æ™¯ã€‚' },
            { icon: 'ğŸª', name: 'é“¶æ²³ä¾¿åˆ©åº—å‘˜', prophecy: 'ç‚¹äº®æ·±å¤œå¾®å…‰ï¼Œå¹³å‡¡åšå®ˆä¹Ÿèƒ½æ¸©æš–é“¶æ²³ã€‚' }
        ];

        const overlay = document.getElementById('overlay');
        const tarotCard = document.getElementById('tarotCard');
        const starsBg = document.getElementById('starsBg');
        const btnWarp = document.getElementById('btnWarp');
        const btnClose = document.getElementById('btnClose');

        let currentCard = null;
        let isFlipped = false;

        // ç”ŸæˆèƒŒæ™¯æ˜Ÿæ˜Ÿ
        function createStars() {
            starsBg.innerHTML = '';
            for (let i = 0; i < 80; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 2 + 's';
                star.style.animationDuration = (1.5 + Math.random() * 1.5) + 's';
                starsBg.appendChild(star);
            }
        }

        function drawTarot() {
            const idx = Math.floor(Math.random() * tarotDeck.length);
            currentCard = tarotDeck[idx];
            isFlipped = false;

            document.getElementById('tarotIcon').textContent = currentCard.icon;
            document.getElementById('tarotNumber').textContent = 'NO. ' + String(idx + 1).padStart(2, '0');
            document.getElementById('tarotTitle').textContent = currentCard.name;
            document.getElementById('tarotProphecy').textContent = currentCard.prophecy;

            tarotCard.classList.remove('flipped', 'revealed');
            overlay.classList.add('show');
            createStars();
        }

        function flipCard() {
            if (isFlipped) return;
            isFlipped = true;
            tarotCard.classList.add('flipped');
            
            setTimeout(() => {
                tarotCard.classList.add('revealed');
            }, 400);
        }

        function closeTarot() {
            tarotCard.classList.remove('flipped', 'revealed');
            setTimeout(() => {
                overlay.classList.remove('show');
            }, 300);
        }

        btnWarp.addEventListener('click', drawTarot);
        tarotCard.addEventListener('click', (e) => {
            if (e.target.id === 'btnClose') return;
            if (!isFlipped) flipCard();
        });
        btnClose.addEventListener('click', closeTarot);
    </script>
</body>
</html>
	`;
}

async function handleWebSocketProxy(targetHost, request, currentHost) {
	try {
		const targetWsUrl = new URL(request.url);
		targetWsUrl.hostname = targetHost;

		const headers = new Headers();
		for (const [key, value] of request.headers.entries()) {
			headers.set(key, value);
		}
		headers.set('X-Forwarded-Host', currentHost);

		const upstreamResponse = await fetch(targetWsUrl.toString(), {
			headers: headers
		});

		const upstreamWs = upstreamResponse.webSocket;
		if (!upstreamWs) {
			return new Response('Upstream WebSocket failed', { status: 502 });
		}
		upstreamWs.accept();

		const clientPair = new WebSocketPair();
		const [clientWs, serverWs] = Object.values(clientPair);
		serverWs.accept();

		serverWs.addEventListener('message', (event) => {
			try { upstreamWs.send(event.data); } catch (e) { }
		});

		upstreamWs.addEventListener('message', (event) => {
			try { serverWs.send(event.data); } catch (e) { }
		});

		serverWs.addEventListener('close', (event) => {
			try { upstreamWs.close(event.code, event.reason); } catch (e) { }
		});

		upstreamWs.addEventListener('close', (event) => {
			try { serverWs.close(event.code, event.reason); } catch (e) { }
		});

		return new Response(null, { status: 101, webSocket: clientWs });

	} catch (err) {
		console.error('WebSocket proxy error:', err);
		return new Response('WebSocket proxy failed: ' + err.message, { status: 502 });
	}
}
